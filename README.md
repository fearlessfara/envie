# Envie

**A tool for managing multiple ephemeral environments in Terraform with layered dependencies and resource sharing.**

Envie is like `pnpm` for `npm`, but for Terraform. It manages complex multi-service Terraform deployments with automatic dependency resolution, environment management, and cross-service state sharing.

## 🚀 Quick Start

### Initialize a New Project

```bash
# Interactive setup
envie init

# Non-interactive setup
envie init --name "my-project" --description "My awesome project" --no-prompt
```

### Deploy a Service

```bash
# Deploy a service with dependencies
envie deploy --service api --merge-request 123

# Deploy with environment overrides
envie deploy --service api --merge-request 123 -E database:stable.sandbox

# Dry run to see what would be deployed
envie deploy --service api --merge-request 123 --dry-run
```

### List Available Services

```bash
envie list
```

## 📁 Project Structure

```
my-project/
├── workspace.envie          # Global project configuration
├── services/                # Service directory
│   ├── networking/          # Networking infrastructure
│   │   ├── .envie          # Service configuration
│   │   └── modules/        # Terraform modules
│   │       ├── vpc/
│   │       ├── subnets/
│   │       └── security-groups/
│   ├── database/            # Database layer
│   │   ├── .envie          # Service configuration
│   │   └── modules/        # Terraform modules
│   │       ├── dynamodb/
│   │       └── rds/
│   └── api/                 # API layer
│       ├── .envie          # Service configuration
│       └── modules/        # Terraform modules
│           ├── lambda/
│           ├── step-functions/
│           └── gateway/
└── README.md                # Project documentation
```

## 🔧 How It Works

### 1. Configuration System

Envie uses a **per-service configuration** approach similar to `pnpm`:

- **`workspace.envie`**: Global project configuration with environment definitions
- **`services/*/.envie`**: Per-service configuration with module dependencies

### 2. Dependency Resolution

Envie automatically resolves dependencies between services and modules:

```yaml
# services/api/.envie
name: api
modules:
  - name: lambda
    path: modules/lambda
    depends:
      - path: ../../database/modules/dynamodb
        environment: stable.sandbox  # Use sandbox database
      - path: ../../networking/modules/vpc
        environment: ephemeral       # Use current MR VPC
```

**Dependency Types:**
- **`../networking`**: Reference to another service
- **`./lambda`**: Reference to module within same service
- **`../../database/modules/dynamodb`**: Cross-service module reference

### 3. Environment Management

Envie supports two types of environments:

#### Ephemeral Environments
- **Purpose**: Temporary development environments
- **Naming**: `{project}-{id}` (e.g., `my-project-123`)
- **State**: Isolated Terraform state per environment
- **Use Case**: Feature branches, merge requests, development

#### Stable Environments
- **Purpose**: Long-lived shared resources
- **Types**: `stable.sandbox`, `stable.staging`, `stable.production`
- **State**: Shared Terraform state across deployments
- **Use Case**: Shared databases, networking, monitoring

### 4. Cross-Service State Sharing

Envie automatically generates `terraform_remote_state` data sources:

```hcl
# Generated by Envie
data "terraform_remote_state" "database_dynamodb" {
  backend = "s3"
  config = {
    bucket = "terraform-state-stable"
    key    = "stable/sandbox/database/dynamodb/terraform.tfstate"
    region = "eu-west-1"
  }
}

# Use in your Terraform code
resource "aws_lambda_function" "api" {
  # ... other config ...
  environment {
    variables = {
      DYNAMODB_TABLE = data.terraform_remote_state.database_dynamodb.outputs.table_name
    }
  }
}
```

### 5. Environment Overrides

Override specific dependencies at deployment time:

```bash
# Use sandbox database but ephemeral networking
envie deploy --service api --merge-request 123 \
  -E database:stable.sandbox \
  -E networking:ephemeral
```

## 📋 Configuration Reference

### Workspace Configuration (`workspace.envie`)

```yaml
version: "1.0"
project:
  name: my-project
  description: My awesome project
services:
  - name: networking
    path: services/networking
  - name: database
    path: services/database
  - name: api
    path: services/api
defaults: {}
```

### Service Configuration (`services/*/.envie`)

```yaml
name: api
description: API layer with Lambda and API Gateway
modules:
  - name: lambda
    path: modules/lambda
    depends:
      - path: ../../database/modules/dynamodb
        environment: stable.sandbox
      - path: ../../networking/modules/vpc
        environment: ephemeral
depends:
  - ../database
  - ../networking
```

### Module Configuration

```yaml
name: lambda
description: Lambda function for API handler
path: modules/lambda
depends:
  - path: ../../database/modules/dynamodb
    environment: stable.sandbox
```

## 🎯 Use Cases

### 1. Microservices Architecture

Deploy individual services with their dependencies:

```bash
# Deploy only the API service, but use existing database and networking
envie deploy --service api --merge-request 123
```

### 2. Feature Development

Create isolated environments for feature development:

```bash
# Create environment for feature branch
envie deploy --service api --merge-request feature-456
```

### 3. Environment Promotion

Promote services through different environments:

```bash
# Deploy to staging with production database
envie deploy --service api --merge-request 123 \
  -E database:stable.production \
  -E networking:stable.staging
```

### 4. Shared Resources

Share resources between different deployments:

```bash
# Multiple services using same networking
envie deploy --service api --merge-request 123
envie deploy --service worker --merge-request 124
# Both use the same networking infrastructure
```

## 🛠️ Commands

### `envie init`
Initialize a new Envie project with scaffolding.

```bash
envie init [--name NAME] [--description DESCRIPTION] [--no-prompt] [--verbose]
```

### `envie deploy`
Deploy a service with dependency management.

```bash
envie deploy --service SERVICE --merge-request ID [OPTIONS]
```

**Options:**
- `--service, -S`: Service name (optional, auto-discovers from current directory)
- `--merge-request`: Environment ID (MR number, feature branch, etc.)
- `--environment, -E`: Override environment for specific dependencies
- `--dry-run, -D`: Simulate deployment without making changes
- `--no-prompt`: Don't prompt for inputs
- `--verbose`: Print detailed output

### `envie destroy`
Destroy the environment for a specific service.

```bash
envie destroy [--merge-request ID] [--dry-run] [--verbose]
```

### `envie list`
List all available services.

```bash
envie list
```

### `envie env`
Manage ephemeral development environments.

```bash
envie env start <merge-request-id>
envie env destroy [merge-request-id]
envie env list
envie env current
```

### `envie output`
Generate environment variables from Terraform outputs.

```bash
envie output [--file FILE] [--verbose]
```

### `envie clean`
Clean Terraform directories and reinitialize.

```bash
envie clean [--service SERVICE] [--upgrade] [--verbose]
```

## 🔄 Workflow Example

### 1. Initialize Project

```bash
envie init --name "my-microservices" --description "My microservices project"
```

### 2. Develop Services

```bash
# Work on networking service
cd services/networking
# Edit Terraform modules...

# Work on database service
cd services/database
# Edit Terraform modules...

# Work on API service
cd services/api
# Edit Terraform modules...
```

### 3. Deploy for Development

```bash
# Deploy networking first
envie deploy --service networking --merge-request 123

# Deploy database (depends on networking)
envie deploy --service database --merge-request 123

# Deploy API (depends on both)
envie deploy --service api --merge-request 123
```

### 4. Deploy with Overrides

```bash
# Use production database but ephemeral networking
envie deploy --service api --merge-request 123 \
  -E database:stable.production \
  -E networking:ephemeral
```

### 5. Clean Up

```bash
# Destroy the environment
envie destroy --merge-request 123
```

## 🏗️ Architecture

### Core Components

1. **Service Discovery**: Automatically discovers services and modules
2. **Dependency Resolution**: Builds dependency graph and resolves paths
3. **Environment Management**: Handles ephemeral vs stable environments
4. **Terraform Generation**: Generates remote state data sources
5. **Terraform Execution**: Runs Terraform commands with proper context

### Key Features

- **Automatic Dependency Resolution**: No manual dependency management
- **Environment Isolation**: Each deployment gets its own Terraform state
- **Cross-Service State Sharing**: Services can access outputs from other services
- **Environment Overrides**: Override specific dependencies at deployment time
- **Terraform Integration**: Works with existing Terraform code without modification

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests
5. Submit a pull request

## 📄 License

This project is licensed under the MIT License - see the LICENSE file for details.

## 🙏 Acknowledgments

- Inspired by `pnpm` for `npm` package management
- Built for complex Terraform deployments
- Designed for microservices architectures